---
layout: post
title: "Quartz部署常见问题与解决方案"
tags: [Obsidian, Github, 自动化部署]
comments: true
author: helpfulcraft
---
### 概述

 **Obsidian + Quartz v4 + GitHub Actions** 搭建个人数字花园，将私有 Obsidian 笔记仓库作为子模块连接到公开的 Quartz fork仓库中，利用 GitHub Actions 实现自动化部署，获得一个公开的知识展示平台

### 一、Git 子模块配置

*   本地测试通过，推送到远程仓库时，提示 `error: 'your-notes-repo/' does not have a commit checked out`
*  因为我没有使用 `git submodule add` 添加子模块，而是手动拉取项目到了主项目内，导致主项目中嵌套了另一个 `.git` 目录
*   **解决方法**
    1.  删除手动拉取的笔记文件夹
    2.  执行正确的子模块添加命令：
        ```bash
        git submodule add <your-private-notes-repo-url> content
        ```
  >需要使用 `git submodule` 来管理子模块，使用git时应避免手动操作文件目录

### 二、GitHub Actions 私有仓库的访问

   `fatal: repository '.../your-private-notes-repo.git' not found`。
*   GitHub Actions 需要在仓库的设置中配置密钥以访问私有仓库

    1.  **生成 SSH 密钥对**：执行 `ssh-keygen -t ed25519 -f quartz_deploy_key`，生成私钥 `quartz_deploy_key` 和公钥`quartz_deploy_key.pub`
    2.  **配置公库 Secret**：将**私钥**添加到公开仓库 `Settings > Secrets and variables > Actions` 中，创建一个 Repository secret ，命名为`SSH_PRIVATE_KEY`
    3.  **配置私库 Deploy Key**：将**公钥**添加到私有仓库 `Settings > Deploy keys` 中，勾选 “Allow write access”
    4.  **更新子模块 URL**：在 `.gitmodules` 中，将子模块的 URL 从 HTTPS 格式改为 SSH 格式 `git@github.com:...`
    5.  **修改 Workflow 文件**：在 `.github/workflows/deploy.yml` 中，配置 `actions/checkout` 以使用 SSH 密钥
        ```yaml
        - name: Checkout repository with submodules
          uses: actions/checkout@v4
          with:
            ssh-key: ${{ secrets.SSH_PRIVATE_KEY }}
            submodules: 'recursive'
        ```

### 三、Actions 部署错误

Node.js 版本不匹配

- 在 `deploy.yml` 中，更新`node-version`
    ```yaml
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: "22" # 从18更新为22
        cache: "npm"
    ```

### 四、GitHub Pages 规则限制

*   从日志中看到`build` 步骤成功后， `deploy` 失败，日志指出 `Branch "main" is not allowed to deploy to github-pages due to environment protection rules.`
*   GitHub 为 `github-pages` 部署环境设置了分支保护规则，默认只允许仓库创建时的第一个分支进行部署。而我在后续的推送中修改了分支名，需要同步修改规则设置
    1.  进入仓库的 `Settings > Environments > github-pages`
    2.  在 `Deployment branches` 中，把旧分支名修改为 `main`

### 五、部署成功，主页面为RSS

*   Actions中部署成功后，进入网站看到的是原始的 XML，并且正上方指出了当前页面为RSS
    1. 这是因为Web服务器没找到默认的入口文件，fork的仓库中不包含`index.html`，自行在obsidian创建一个名为index.html的MOC即可

### 七、总结
*   **子模块管理**: 确保使用 `git submodule` 命令正确添加和管理私有笔记仓库，避免手动操作文件目录。
*   **GitHub Actions 私有仓库访问**: 配置 SSH 密钥对，将私钥作为 GitHub Actions Secret，公钥作为私有仓库的 Deploy Key，并更新 `.gitmodules` 和 `deploy.yml` 中的相关配置。
*   **Node.js 版本兼容**: 检查并更新 `deploy.yml` 中 `actions/setup-node` 的 `node-version`，以匹配 Quartz 的构建要求。
*   **GitHub Pages 分支保护**: 若遇到部署失败，检查 GitHub Pages 环境的分支保护规则，确保允许部署的分支与实际部署分支一致。
*   **主页显示异常**: 如果部署成功后主页显示为 RSS XML，通常是缺少 `index.html` 文件，需要在 Obsidian 中创建相应的 MOC。


>