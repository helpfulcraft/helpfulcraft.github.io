---
layout: post
title: "我的第一个DST模组：解决资源编译问题"
tags: [DST, Modding, Lua, 游戏开发]
comments: true
author: helpfulcraft
---

### 背景

作为《饥荒：联机版》(DST)玩家，我决定尝试开发我的第一个模组：一个在玩家出生时自动获得的静态攻略书。

我的初始目标很明确：
1.  创建一个新物品 `atlas_book`。
2.  为该物品提供一个自定义的物品栏图标。
3.  玩家出生时在物品栏中生成该物品。

我搭建了基础的模组结构，包括 `modinfo.lua`，`modmain.lua` 和物品的 Prefab 文件。但很快遇到了第一个核心障碍：游戏引擎不直接使用 `.png` 文件，而是需要经过编译的 `.tex` (纹理) 和 `.xml` (图集) 文件。

### 1. 问题：自动化编译流程失效

根据现代教程，DST 的资源编译采用一个自动化流程。理论上，我只需：
1.  在模组根目录创建 `exported` 文件夹。
2.  在 `exported` 内，按期望的输出目录结构放置 `.png` 文件 (如 `exported/images/inventoryimages/atlas_book.png`)。
3.  启动游戏，模组加载时会自动编译 `exported` 内的资源，并在模组的 `images` 目录下生成对应的 `.tex` 和 `.xml` 文件。

然而，这个流程在我的环境中并未生效。

我反复检查了文件路径，修改了 `modinfo.lua` 中的配置，并清理了游戏缓存。但无论如何重启，预期的 `.tex` 和 `.xml` 文件始终没有被创建，导致模组图标无法显示，物品也无法正确加载。

### 2. 解决方案：手动执行 `autocompiler.exe`

在排查中，我在 Steam 的游戏工具目录内发现了一个可执行文件：
`Don't Starve Mod Tools/mod_tools/autocompiler.exe`

这与我了解到的“全自动流程”不同。查阅了一些早期教程后，我确认这是一条可行的**手动编译**路径。

#### 手动编译步骤
1.  **准备环境**：直接运行 `autocompiler.exe` 会因缺少依赖而失败。需要将 `Don't Starve Mod Tools/mod_tools/` 目录下的整个 `compiler` 文件夹，复制到我的模组根目录中。
2.  **执行编译**：在我的模组文件夹内，运行 `compiler/autocompiler.exe`。程序启动一个命令行窗口，成功将我放置在模组目录中的所有 `.png` 文件（如 `modicon.png` 和 `images/inventoryimages/atlas_book.png`）编译成了 `.tex` 和 `.xml` 文件，并放置在源文件相同的位置。

看到新文件生成后，我知道核心障碍已被清除。

### 3. 实现与整合

解决了资源编译问题，我开始整合代码。

1.  **清理项目**：删除了临时的 `compiler` 文件夹和不再需要的 `exported` 文件夹，保持模组目录整洁。

2.  **配置 `modinfo.lua`**：确保 `icon_atlas` 和 `icon` 指向编译好的文件。
    ```lua
    -- modinfo.lua
    name = "Codex Astralis"
    icon_atlas = "modicon.xml"
    icon = "modicon.tex"
    -- ...
    ```

3.  **加载物品资源**：在物品的 `Prefab` 文件 (`scripts/atlas_book.lua`) 中，声明需要加载的资源，并指定物品栏图标的图集。
    ```lua
    -- scripts/atlas_book.lua
    local assets = {
        Asset("ATLAS", "images/inventoryimages/atlas_book.xml"),
        Asset("IMAGE", "images/inventoryimages/atlas_book.tex"),
    }
    -- ...
    inst.components.inventoryitem.atlasname = "images/inventoryimages/atlas_book.xml"
    ```

4.  **编写主逻辑 `modmain.lua`**：监听玩家进入世界的事件，并在服务器主世界 (`mastersim`) 中为其添加物品。
    ```lua
    -- modmain.lua
    PrefabFiles = { "atlas_book" }

    AddPrefabPostInit("player_classified", function(inst)
        inst:ListenForEvent("ms_playeractivated", function(inst, player)
            if TheWorld.ismastersim and not player.persists.has_atlas_book then
                player.components.inventory:GiveItem(SpawnPrefab("atlas_book"))
                player.persists.has_atlas_book = true
            end
        end)
    end)
    ```

最终，启用模组并进入游戏后，角色物品栏中成功出现了带有自定义图标的攻略书。

### 总结
> *   DST 模组开发存在两种资源编译路径：现代的自动化 `exported` 流程，以及较旧的 `autocompiler.exe` 手动编译。
> *   当标准的自动化流程因环境问题失效时，手动编译是一个可靠的备用方案。
> *   在开发中遇到复杂问题时，应优先隔离并解决最核心的阻塞点（如此次的资源编译），再继续构建上层功能。这能让开发过程更清晰可控。

```