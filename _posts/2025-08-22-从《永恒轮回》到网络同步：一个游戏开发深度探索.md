---
layout: post
title: "从《永恒轮回》到网络同步：一个游戏开发深度探索"
tags: [游戏开发, 网络同步, MOBA, 状态同步]
date: 2025-08-22
comments: true
author: helpfulcraft
---

### 背景

“那款叫《永恒轮回》的游戏，公司好像没什么名气，它是怎么做出来的？”

作为一名游戏开发者，即便有着在游戏社区耳濡目染的经验，对于世界风靡的游戏类型——MOBA背后的技术原理仍一无所知。通过查阅资料、询问LLM，我学到了许多宝贵的知识。这次探索，让我清晰地看到了支撑多人在线竞技体验的底层技术架构与设计哲学


### 1. 《永恒轮回》的差异化竞争

《永恒轮回》的开发商 Nimble Neuron 并非行业巨头。中小型工作室的生存法则通常是**差异化竞争**

该游戏融合了 **MOBA的操作、大逃杀的生存机制和合成系统的策略**，这种元素重组在饱和的市场中找到了独特的生态位。这揭示了第一个观察点：**创新并非总是颠覆性的，也可以是现有元素的巧妙重组**

### 2. 网络同步模型

主流网络游戏主要采用两种不同的技术路线

> #### 技术背景：两种主流同步方案
> 
> *   **状态同步 (State Synchronization) - FPS游戏的选择**
>     *   **核心思想**: 客户端预测先行，服务端权威验证
>     *   **工作流程**: 客户端立即执行玩家操作并显示“预测”结果，同时将操作发送给服务器。服务器验证操作的合法性，并广播权威的游戏状态，纠正所有客户端的偏差
>     *   **体验**: 操作响应快，延迟感低。网络波动时，由于服务器的强制纠正，会出现“瞬移”、“拉扯”现象
> 
> *   **确定性锁帧同步 (Deterministic Lockstep) - MOBA/RTS游戏的选择**
>     *   **核心思想**: 服务端统一指令，所有客户端严格执行
>     *   **工作流程**: 客户端仅将玩家的“操作指令”（如“在T时刻按下Q键”）发送给服务器。服务器收集一个时间帧内所有玩家的指令，打包后广播给所有客户端。所有客户端在同一时刻，执行完全相同的指令集
>     *   **体验**: 保证所有玩家的游戏世界在逻辑上100%一致，杜绝了修改内存数据的外挂。代价是操作需要经过一次网络往返（RTT）才能被执行，高延迟下会感到“技能延迟”或“角色迟钝”

这个发现解释了不同游戏类型网络体验差异的根源。这是一个设计哲学上的根本取舍：**FPS为个人操作的极致响应，牺牲了一致性；MOBA为多方博弈的绝对公平，牺牲了零延迟的操作感**

### 3. 关键技术点

*   **MOBA录像为何版本更新后会失效？**
    原因是录像文件并非视频，而是“操作指令”的脚本。当游戏逻辑（如技能伤害、冷却时间）更新后，使用旧的指令脚本去运行新版本的游戏逻辑，必然导致结果不一致，从而“播放失败”

*   **MOBA开发为何困难？**
    一个关键难点是**浮点数精度**问题。不同架构的CPU或不同操作系统在计算同一个浮点数时，可能会产生二进制级别的微小差异。在锁帧同步模型中，这个微小差异经过成千上万次迭代计算后会被放大，最终导致客户端之间状态不一致（“失同步”），使对局崩溃。开发者必须使用**定点数**或特殊的浮点数处理库，以确保所有计算在任何机器上都得到完全相同的结果

*   **为什么FPS外挂感觉更多？**
    状态同步模型为了让客户端能流畅地预测，必须提前将附近敌人的位置等信息发送过来。这为“透视”和“自瞄”等外挂提供了直接利用数据的机会。而锁帧同步从机制上决定了客户端只接收操作指令，无法预知未来状态，因此难以出现修改游戏核心数值（如血量、CD）的外挂

### 4. “拔网线”会发生什么？

在标准的 Client-Server 架构中，如果玩家拔掉网线，其客户端会与服务器失联。服务器通过“心跳包”和“超时检测”机制发现该玩家掉线，其在服务器上的角色将变为静止状态，任由其他玩家攻击。玩家在自己屏幕上看到的“单机无敌”只是客户端的本地幻象

### 5. ：GTA5 的 P2P 网络与 BUG 温床

然而，并非所有游戏都遵循严格的 C/S 架构。《GTA5》的公开战局采用了 **P2P (Peer-to-Peer)** 网络架构

在一个战局（Session）中，部分数据由玩家之间直接交换，甚至会动态选举一名玩家作为“主机”(Host)，临时承担部分服务器的职责。这种架构节省了官方服务器成本，但将安全与稳定性问题转移给了玩家客户端。如果作弊者成为主机，他几乎拥有修改战局内游戏规则的权限，因为其他客户端被设计为需要“信任”主机发来的信息以维持同步

这种宽松的 P2P 环境，加上客户端拥有较高的自治权，也成为了 BUG 的温床。例如经典的“拔网线刷钱”BUG，就是利用了**客户端本地的“乐观更新”和服务器在处理异常掉线后的“保守回滚”逻辑**之间的时间差与状态不一致，从而凭空创造出数据

### 6. 从状态机看 BUG 成因

更深层次的BUG，如“穿墙”，往往源于游戏引擎底层的**状态机 (State Machine)** 逻辑漏洞

这类BUG的本质是，通过在特定时机执行一个操作（如“拍照”），强制中断另一个正在进行的、与角色物理状态相关的操作（如“攀爬”）。这可能导致角色的**逻辑状态与物理状态发生“解耦”**。当这个被异常保留的逻辑状态在新的位置被意外触发时，便会产生瞬移等预期外的效果，让玩家得以穿墙或进入非法区域

### 总结

> *   **架构决定体验**: 网络同步模型（状态同步 vs. 锁帧同步）是设计上的权衡，直接决定了游戏的操作手感、公平性和外挂对抗的难度
> *   **确定性是诅咒也是恩赐**: 锁帧同步对“确定性”的要求极高，浮点数等非确定性因素是开发中的主要难点，但它也从根源上保证了对局的公平性
> *   **权限等于风险**: 客户端的权限越大（如状态同步中的预测、P2P中的主机），潜在的安全风险和BUG向量就越多。服务器永远是最终的权威
> *   **BUG源于状态解耦**: 许多看似神奇的BUG，其微观成因可追溯到程序状态机中逻辑状态与物理状态的非预期分离
